package quilt.internal.tasks.build;

import java.io.File;

import org.gradle.api.tasks.OutputFile;
import org.gradle.api.tasks.TaskAction;
import quilt.internal.Constants;
import quilt.internal.tasks.DefaultMappingsTask;

import net.fabricmc.stitch.commands.tinyv2.CommandMergeTinyV2;
import net.fabricmc.stitch.commands.tinyv2.CommandReorderTinyV2;

public class MergeTinyV2Task extends DefaultMappingsTask {
    public static final String TASK_NAME = "mergeTinyV2";

    @OutputFile
    public File merged = new File(fileConstants.tempDir, "merged.tiny");

    public MergeTinyV2Task() {
        super(Constants.Groups.BUILD_MAPPINGS_GROUP);
        outputsNeverUpToDate();
        getOutputs().file(merged);
        dependsOn(InvertPerVersionMappingsTask.TASK_NAME, "v2UnmergedMappingsJar");
    }

    @TaskAction
    public void mergeMappings() throws Exception {
        File hashedTinyInput = this.getTaskByType(InvertPerVersionMappingsTask.class).invertedTinyFile;
        File autoGeneratedEnumMappings = this.getTaskByName("insertAutoGeneratedEnumMappings").getOutputs().getFiles().getSingleFile();

        File unorderedResultMappings = new File(fileConstants.tempDir, "merged-reordered.tiny");

        getLogger().lifecycle(":merging {} and {}", Constants.MAPPINGS_NAME, Constants.PER_VERSION_MAPPINGS_NAME);
        String[] args = {
                hashedTinyInput.getAbsolutePath(),
                autoGeneratedEnumMappings.getAbsolutePath(),
                unorderedResultMappings.getAbsolutePath(),
                Constants.PER_VERSION_MAPPINGS_NAME,
                "official"
        };

        new CommandMergeTinyV2().run(args);

        getLogger().lifecycle(":reordering merged {}", Constants.PER_VERSION_MAPPINGS_NAME);
        String[] args2 = {
                unorderedResultMappings.getAbsolutePath(),
                merged.getAbsolutePath(),
                "official", Constants.PER_VERSION_MAPPINGS_NAME, "named"
        };

        new CommandReorderTinyV2().run(args2);
    }

    public File getMerged() {
        return merged;
    }
}
